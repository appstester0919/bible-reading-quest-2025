'use client'

import { useEffect, useState } from 'react'
import { ALL_BOOKS } from '@/lib/bibleData'
// Lazy load confetti to avoid iOS issues
const confetti = typeof window !== 'undefined' ? 
  require('canvas-confetti') : 
  null
import Modal from '../../components/ui/Modal'
import dynamic from 'next/dynamic'

interface MapViewProps {
  completedBooks: string[];
  showEncouragement: boolean;
  showFireworks: boolean;
}

// ç”ŸæˆçœŸå¯¦æ‹¼åœ–å½¢ç‹€
const getPuzzleShape = (id: number) => {
  const baseShapes = [
    // æœ‰å³å‡¸èµ·çš„æ‹¼åœ–
    `polygon(0% 0%, 70% 0%, 75% -5%, 85% -5%, 90% 0%, 100% 0%, 100% 100%, 0% 100%)`,
    // æœ‰ä¸‹å‡¸èµ·çš„æ‹¼åœ–  
    `polygon(0% 0%, 100% 0%, 100% 70%, 105% 75%, 105% 85%, 100% 90%, 100% 100%, 0% 100%)`,
    // æœ‰å·¦å‡¹æ§½çš„æ‹¼åœ–
    `polygon(0% 0%, 100% 0%, 100% 100%, 30% 100%, 25% 105%, 15% 105%, 10% 100%, 0% 100%)`,
    // æœ‰ä¸Šå‡¹æ§½çš„æ‹¼åœ–
    `polygon(0% 0%, 30% 0%, 25% -5%, 15% -5%, 10% 0%, 0% 0%, 0% 100%, 100% 100%, 100% 0%)`,
    // æ¨™æº–çŸ©å½¢
    `polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%)`
  ];
  
  return baseShapes[id % baseShapes.length];
};

// ç”Ÿæˆ 11x6 æ‹¼åœ–ç¶²æ ¼ (é…åˆåœ°åœ–æ¯”ä¾‹ï¼šæ©«6ç›´11)
const generatePuzzleGrid = () => {
  const grid = [];
  const cols = 6;  // æ©«å‘6æ ¼
  const rows = 11; // ç›´å‘11æ ¼
  
  for (let row = 0; row < rows; row++) {
    for (let col = 0; col < cols; col++) {
      const index = row * cols + col;
      if (index < 66) { // åªç”Ÿæˆ66å¡Šæ‹¼åœ–
        grid.push({
          id: index,
          book: ALL_BOOKS[index],
          x: (col / cols) * 100,
          y: (row / rows) * 100,
          width: 100 / cols,
          height: 100 / rows,
          isNewlyCompleted: false
        });
      }
    }
  }
  return grid;
};

export default function MapView({ completedBooks, showEncouragement, showFireworks }: MapViewProps) {
  const [showModal, setShowModal] = useState(false);
  const [puzzleGrid, setPuzzleGrid] = useState(() => generatePuzzleGrid());
  const [previousCompletedCount, setPreviousCompletedCount] = useState(0);

  useEffect(() => {
    if (showEncouragement) {
      setShowModal(true);
    }
  }, [showEncouragement]);

  useEffect(() => {
    // iOS Safari confetti compatibility check
    if (showFireworks && confetti && typeof confetti === 'function') {
      try {
        const duration = 5 * 1000;
        const end = Date.now() + duration;

        (function frame() {
          if (Date.now() < end) {
            try {
              confetti({
                particleCount: 2,
                angle: 60,
                spread: 55,
                origin: { x: 0 },
              });
              confetti({
                particleCount: 2,
                angle: 120,
                spread: 55,
                origin: { x: 1 },
              });
              requestAnimationFrame(frame);
            } catch (error) {
              console.warn('Confetti animation failed:', error);
            }
          }
        }());
      } catch (error) {
        console.warn('Confetti initialization failed:', error);
      }
    }
  }, [showFireworks]);

  const completedSet = new Set(completedBooks);

  // æª¢æ¸¬æ–°å®Œæˆçš„æ‹¼åœ–å¡Šä¸¦è§¸ç™¼å‹•ç•«
  useEffect(() => {
    if (completedBooks.length > previousCompletedCount) {
      // æœ‰æ–°å®Œæˆçš„æ›¸å·ï¼Œè§¸ç™¼æ‹¼åœ–æ‰è½å‹•ç•«
      const newlyCompletedBooks = completedBooks.slice(previousCompletedCount);
      
      setPuzzleGrid(prev => prev.map(piece => ({
        ...piece,
        isNewlyCompleted: newlyCompletedBooks.includes(piece.book.name)
      })));

      // 3ç§’å¾Œæ¸…é™¤å‹•ç•«ç‹€æ…‹
      setTimeout(() => {
        setPuzzleGrid(prev => prev.map(piece => ({
          ...piece,
          isNewlyCompleted: false
        })));
      }, 3000);
    }
    setPreviousCompletedCount(completedBooks.length);
  }, [completedBooks, completedBooks.length, previousCompletedCount]);

  return (
    <>
      <div className="w-full bg-gradient-to-b from-amber-100 via-yellow-50 to-orange-100 rounded-lg p-4 shadow-inner relative overflow-hidden">
        <div className="text-center mb-6">
          <h2 className="text-2xl font-bold text-gray-800 mb-2">ğŸ§© æ‡‰è¨±ä¹‹åœ°æ‹¼åœ–</h2>
          <p className="text-gray-600">å®Œæˆæ¯å·è–ç¶“ï¼Œè§£é–ä¸€å¡Šè–åœ°æ‹¼åœ–</p>
          <div className="text-sm text-gray-500 mt-2">
            å·²è§£é– {completedBooks.length} / 66 å¡Šæ‹¼åœ–
          </div>
        </div>

        {/* æ‹¼åœ–åœ°åœ–å®¹å™¨ */}
        <div className="relative w-full mx-auto rounded-lg overflow-hidden shadow-lg" 
             style={{ 
               aspectRatio: '6/11',  // ä¿®æ­£ç‚ºæ©«6ç›´11çš„æ¯”ä¾‹
               maxWidth: '100%',
               // iOS Safari compatibility
               WebkitTransform: 'translateZ(0)',
               transform: 'translateZ(0)'
             }}>
          
          {/* çœŸå¯¦ä»¥è‰²åˆ—åœ°åœ–èƒŒæ™¯å±¤ */}
          <div 
            className="absolute inset-0 w-full h-full bg-cover bg-center bg-no-repeat rounded-lg"
            style={{
              backgroundImage: 'url(/Map.png)',
              backgroundSize: 'cover',
              backgroundPosition: 'center'
            }}
          >
            {/* åœ°åœ–è¦†è“‹å±¤ï¼Œå¢å¼·å°æ¯”åº¦ */}
            <div className="absolute inset-0 bg-gradient-to-br from-amber-50/20 via-transparent to-amber-100/20"></div>
            
            {/* é‚Šç•Œæ¡† */}
            <div className="absolute inset-0 border-4 border-amber-700 rounded-lg opacity-80 shadow-inner"></div>
          </div>

          {/* æ‹¼åœ–å¡Š */}
          {puzzleGrid.map((piece) => {
            const isCompleted = completedSet.has(piece.book.name);
            return (
              <div
                key={piece.id}
                className={`absolute transition-all duration-700 cursor-pointer group ${
                  isCompleted 
                    ? 'opacity-100 z-10' 
                    : 'opacity-90 hover:opacity-100'
                } ${piece.isNewlyCompleted ? 'animate-puzzle-drop' : ''}`}
                style={{
                  left: `${piece.x}%`,
                  top: `${piece.y}%`,
                  width: `${piece.width}%`,
                  height: `${piece.height}%`,
                }}
                title={`${piece.book.name} ${isCompleted ? '(å·²å®Œæˆ)' : '(æœªå®Œæˆ)'}`}
              >
                {/* æ‹¼åœ–å¡ŠèƒŒæ™¯ */}
                <div 
                  className="w-full h-full relative"
                  style={{
                    clipPath: getPuzzleShape(piece.id),
                    border: isCompleted 
                      ? '2px solid rgba(34, 197, 94, 0.9)' 
                      : '3px solid rgba(120, 120, 120, 0.9)',
                    boxShadow: isCompleted 
                      ? '0 0 15px rgba(34, 197, 94, 0.8), inset 0 1px 3px rgba(255, 255, 255, 0.2)' 
                      : '0 3px 12px rgba(0, 0, 0, 0.4), inset 0 2px 4px rgba(0, 0, 0, 0.2)',
                    background: isCompleted 
                      ? 'rgba(255, 255, 255, 0.05)' 
                      : `linear-gradient(135deg, 
                          rgba(200, 200, 200, 0.98) 0%, 
                          rgba(180, 180, 180, 0.98) 50%, 
                          rgba(160, 160, 160, 0.98) 100%
                        )`,
                    // iOS Safari performance optimization
                    WebkitTransform: 'translateZ(0)',
                    transform: 'translateZ(0)',
                    WebkitBackfaceVisibility: 'hidden',
                    backfaceVisibility: 'hidden'
                  }}
                >
                  {/* æ‹¼åœ–å¡Šå…§å®¹ */}
                  <div className="absolute inset-0 flex flex-col items-center justify-center p-1">
                    {/* æ›¸å·åç¨± */}
                    <div className={`text-center ${
                      piece.width < 12 ? 'text-xs' : 'text-sm'
                    } font-bold ${
                      isCompleted 
                        ? 'text-white drop-shadow-lg' // å®Œæˆçš„æ‹¼åœ–ç”¨ç™½è‰²æ–‡å­—ï¼Œæœ‰é™°å½±
                        : 'text-gray-700' // æœªå®Œæˆç”¨æ·±ç°è‰²
                    } leading-tight`}>
                      {piece.book.name.length > 6 
                        ? piece.book.name.substring(0, 4) + '...' 
                        : piece.book.name
                      }
                    </div>
                    
                    {/* å®Œæˆæ¨™è¨˜ */}
                    {isCompleted && (
                      <div className="text-white text-lg font-bold drop-shadow-lg animate-pulse">
                        âœ“
                      </div>
                    )}
                  </div>

                  {/* æ‹¼åœ–å¡Šå…‰æ¾¤æ•ˆæœ */}
                  {isCompleted && (
                    <div 
                      className="absolute inset-0 bg-gradient-to-br from-white/30 via-transparent to-transparent pointer-events-none"
                      style={{
                        clipPath: `polygon(
                          ${2 + Math.sin(piece.id) * 3}% ${2 + Math.cos(piece.id) * 3}%, 
                          ${97 + Math.sin(piece.id + 1) * 3}% ${2 + Math.cos(piece.id + 1) * 3}%, 
                          ${97 + Math.sin(piece.id + 2) * 3}% ${97 + Math.cos(piece.id + 2) * 3}%, 
                          ${2 + Math.sin(piece.id + 3) * 3}% ${97 + Math.cos(piece.id + 3) * 3}%
                        )`
                      }}
                    />
                  )}
                </div>

                {/* æ‡¸åœæç¤º */}
                <div className="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap z-20">
                  {piece.book.name} ({piece.book.chapters}ç« )
                </div>
              </div>
            );
          })}
        </div>

        {/* é€²åº¦çµ±è¨ˆ */}
        <div className="mt-6 p-4 bg-white/80 rounded-lg shadow">
          <div className="flex justify-between items-center mb-2">
            <span className="text-gray-700 font-medium">æ‹¼åœ–å®Œæˆåº¦</span>
            <span className="text-2xl font-bold text-green-600">
              {Math.round((completedBooks.length / ALL_BOOKS.length) * 100)}%
            </span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-3">
            <div
              className="bg-gradient-to-r from-green-400 to-emerald-500 h-3 rounded-full transition-all duration-500"
              style={{ width: `${(completedBooks.length / ALL_BOOKS.length) * 100}%` }}
            ></div>
          </div>
          <div className="text-center mt-2 text-sm text-gray-600">
            {completedBooks.length === ALL_BOOKS.length 
              ? "ğŸ‰ æ­å–œï¼æ‚¨å·²ç¶“å®Œå…¨å¾—è‘—æ‡‰è¨±ä¹‹åœ°ï¼" 
              : `é‚„éœ€è¦ ${ALL_BOOKS.length - completedBooks.length} å¡Šæ‹¼åœ–ï¼Œå°±èƒ½å®Œå…¨çœ‹è¦‹è–åœ°å…¨è²Œ`
            }
          </div>
          <div className="text-center mt-1 text-xs text-gray-500">
            ğŸ’¡ å®Œæˆæ›¸å·å¾Œï¼Œæ‹¼åœ–æœƒè®Šé€æ˜ï¼Œé¡¯ç¤ºåº•ä¸‹çš„çœŸå¯¦è–åœ°åœ°åœ–
          </div>
          <div className="text-center mt-1 text-xs text-blue-600 font-medium">
            ğŸ—ºï¸ æ¯å®Œæˆä¸€å·æ›¸ï¼Œå°±èƒ½&quot;å¾—è‘—&quot;ä¸€å¡Šæ‡‰è¨±ä¹‹åœ°ï¼
          </div>
        </div>
        
        {/* ç‰ˆæ¬Šè²æ˜ */}
        <div className="mt-4 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500">
          <div className="text-xs text-gray-600 leading-relaxed">
            <div className="font-semibold text-gray-700 mb-1">ğŸ“ åœ°åœ–ä¾†æº</div>
            <div>
              åœ°åœ–ä¾†è‡ª{' '}
              <a 
                href="https://biblegeography.holylight.org.tw/index/condensedbible_map_detail?m_id=106" 
                target="_blank" 
                rel="noopener noreferrer"
                className="text-blue-600 hover:text-blue-800 underline"
              >
                è–å…‰è–ç¶“åœ°ç†è³‡è¨Šç¶²
              </a>
            </div>
            <div className="mt-1 text-gray-500">
              æŒ‰å…¶ç‰ˆæ¬Šèªªæ˜æ­¡è¿ä½œæ•™æœƒå…§éç‰Ÿåˆ©ä½¿ç”¨
            </div>
          </div>
        </div>
      </div>

      {showFireworks && (
        <h2 className='text-center text-2xl font-bold text-green-600 mt-4'>
          ğŸ‰ æ­å–œï¼æ‚¨å·²ç¶“å®Œå…¨å¾—è‘—æ‡‰è¨±ä¹‹åœ°ï¼ğŸ‰
        </h2>
      )}
      
      <Modal isOpen={showModal} onClose={() => setShowModal(false)}>
        <h2 className="text-xl font-bold">ğŸ§© æ‹¼åœ–è§£é–ï¼</h2>
        <p className="mt-2">æ‚¨åˆè§£é–äº†æ–°çš„æ‹¼åœ–å¡Šï¼ç¹¼çºŒåŠªåŠ›ï¼Œå®Œæˆæ•´å¹…æ‡‰è¨±ä¹‹åœ°çš„åœ°åœ–ï¼</p>
      </Modal>

      {/* æ‹¼åœ–å‹•ç•« CSS */}
      <style jsx>{`
        @keyframes puzzle-drop {
          0% { 
            transform: translateY(-100px) rotate(15deg) scale(1.2); 
            opacity: 0; 
          }
          60% { 
            transform: translateY(10px) rotate(-5deg) scale(1.1); 
            opacity: 0.8; 
          }
          80% { 
            transform: translateY(-5px) rotate(2deg) scale(1.05); 
            opacity: 0.9; 
          }
          100% { 
            transform: translateY(0) rotate(0deg) scale(1); 
            opacity: 1; 
          }
        }
        
        @keyframes puzzle-glow {
          0%, 100% { 
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.4), 
                        inset 0 2px 4px rgba(255, 255, 255, 0.4); 
          }
          50% { 
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.8), 
                        inset 0 2px 4px rgba(255, 255, 255, 0.6),
                        0 0 30px rgba(251, 191, 36, 0.6); 
          }
        }
        
        .animate-puzzle-drop {
          animation: puzzle-drop 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .animate-puzzle-glow {
          animation: puzzle-glow 2s ease-in-out infinite;
        }
      `}</style>
    </> 
  )
}